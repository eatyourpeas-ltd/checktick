#!/bin/bash
# Security audit script for dependency vulnerabilities
# Run this locally or in CI to check for known vulnerabilities

set -e

echo "ğŸ”’ CheckTick Security Audit"
echo "==========================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if pip-audit is installed
if ! command -v pip-audit &> /dev/null; then
    echo -e "${YELLOW}pip-audit not found. Installing...${NC}"
    pip install pip-audit
fi

echo "ğŸ“¦ Checking production dependencies..."
echo ""

# Export requirements if poetry is available
if command -v poetry &> /dev/null; then
    poetry export -f requirements.txt --without-hashes -o /tmp/requirements-audit.txt 2>/dev/null
    REQUIREMENTS_FILE="/tmp/requirements-audit.txt"
elif [ -f "requirements.txt" ]; then
    REQUIREMENTS_FILE="requirements.txt"
else
    echo -e "${RED}Error: No requirements.txt found and poetry not available${NC}"
    exit 1
fi

# Run pip-audit
AUDIT_OUTPUT=$(pip-audit -r "$REQUIREMENTS_FILE" --format json 2>/dev/null || true)

# Parse results
VULN_COUNT=$(echo "$AUDIT_OUTPUT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data.get('dependencies', [])))" 2>/dev/null || echo "0")

if [ "$VULN_COUNT" = "0" ] || [ -z "$VULN_COUNT" ]; then
    echo -e "${GREEN}âœ… No known vulnerabilities found in production dependencies${NC}"
else
    echo -e "${RED}âŒ Found $VULN_COUNT vulnerable dependencies:${NC}"
    echo ""
    pip-audit -r "$REQUIREMENTS_FILE" --format columns
    echo ""
    echo -e "${YELLOW}Run 'pip-audit -r requirements.txt --fix' to auto-fix where possible${NC}"
    exit 1
fi

echo ""
echo "ğŸ“¦ Checking dev dependencies..."
echo ""

if command -v poetry &> /dev/null; then
    poetry export -f requirements.txt --without-hashes --with dev -o /tmp/requirements-dev-audit.txt 2>/dev/null
    pip-audit -r /tmp/requirements-dev-audit.txt --format columns 2>/dev/null || {
        echo -e "${YELLOW}âš ï¸  Some dev dependencies have known vulnerabilities (non-blocking)${NC}"
    }
else
    echo -e "${YELLOW}Skipping dev dependencies (poetry not available)${NC}"
fi

echo ""
echo -e "${GREEN}ğŸ”’ Security audit complete${NC}"
